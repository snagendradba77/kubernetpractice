name: Kubernetes Project Test Cases

on:
  push:
    branches:
      - dev
    paths:
      - 'tests/**'
  workflow_dispatch:

jobs:
  k8s-tests:
    runs-on: self-hosted

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Set up kubectl"
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: "Configure kubeconfig"
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_CONTENT }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config

      - name: "Sanity check cluster access"
        run: kubectl cluster-info

      # ðŸ”¹ Cluster Tests
      - name: "Verify cluster nodes are healthy"
        run: kubectl get nodes

      - name: "Verify namespace exists"
        run: kubectl get namespaces | grep db

      # ðŸ”¹ Storage Tests
      - name: "Verify PersistentVolume is bound"
        run: kubectl get pv | grep Bound

      - name: "Verify PVC is attached"
        run: kubectl get pvc -n db | grep Bound

      # ðŸ”¹ Database Tests
      - name: "Verify PostgreSQL pod is running"
        run: kubectl get pods -n db | grep postgres

      - name: "Verify DB connection"
        run: kubectl -n db exec deploy/postgres -- psql -U Naga -d appdb -c "SELECT 1"

      # ðŸ”¹ Application Tests
      - name: "Verify service exposes app"
        run: kubectl get svc -n db | grep python-app-service

      - name: "Port-forward Flask app and test root response"
        run: |
          kubectl port-forward svc/python-app-service -n db 5000:5000 > port-forward.log 2>&1 &
          PF_PID=$!
          sleep 5
          curl -s http://localhost:5000/
          kill $PF_PID

      - name: "End-to-End test: Verify app inserts user into DB"
        run: |
          kubectl port-forward svc/python-app-service -n db 5000:5000 > port-forward.log 2>&1 &
          PF_PID=$!
          sleep 5
          curl -X POST "http://localhost:5000/insert_user" \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","email":"testuser@example.com"}'
          kubectl -n db exec deploy/postgres -- psql -U Naga -d appdb -c "SELECT * FROM users WHERE email = 'testuser@example.com';"
          kill $PF_PID

