name: Kubernetes Project Test Cases

on:
  push:
    branches:
      - dev
    paths:
      - 'tests/**'
  workflow_dispatch:

jobs:
  k8s-tests:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubeconfig
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_CONTENT }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config

      - name: Sanity check cluster access
        run: kubectl cluster-info

      # üîπ Cluster Tests
      - name: Verify cluster nodes are healthy
        run: kubectl get nodes

      - name: Verify namespace exists
        run: kubectl get namespaces | grep db

      # üîπ Storage Tests
      - name: Verify PersistentVolume is bound
        run: kubectl get pv | grep Bound

      - name: Verify PVC is attached
        run: kubectl get pvc -n db | grep Bound

      # üîπ Database Tests
      - name: Verify PostgreSQL pod is running
        run: kubectl get pods -n db | grep postgres

      - name: Verify DB connection
        run: kubectl -n db exec deploy/postgres -- psql -U Naga -c "SELECT 1"

      # üîπ Application Tests
      - name: Verify service exposes app
        run: kubectl get svc -n db | grep python-app-service

      - name: Port-forward Flask app and test response
        run: |
          kubectl port-forward svc/python-app-service -n db 5000:5000 > port-forward.log 2>&1 &
          PF_PID=$!
          sleep 5
          RESPONSE=$(curl -s http://localhost:5000/)
          echo "$RESPONSE"
          if echo "$RESPONSE" | grep -q "Welcome"; then
          echo "‚úÖ App responded correctly"
          else
          echo "‚ùå App response did not contain 'Welcome'"
          exit 1
          fi
          kill $PF_PID




      - name: Verify app inserts data into DB
        run: |
          curl -s http://localhost:5000/add?record=test
          kubectl -n db exec deploy/postgres -- psql -U Naga -d db -c "SELECT * FROM records WHERE name='test'"

