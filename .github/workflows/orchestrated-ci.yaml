name: Orchestrated CI/CD

on:
  push:
    branches:
      - dev
    paths:
      - 'infra/**'
      - 'db/**'
      - 'app/**'

jobs:
  orchestrated-deploy:
    runs-on: self-hosted
    environment: dev

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Setup kubectl
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    # 3Ô∏è‚É£ Terraform Init
    - name: Terraform Init
      working-directory: infra
      run: terraform init

    # 4Ô∏è‚É£ Terraform Apply
    - name: Terraform Apply
      working-directory: infra
      run: terraform apply -auto-approve

    # 5Ô∏è‚É£ Apply PostgreSQL PVC
    - name: Apply PostgreSQL PVC
      run: kubectl apply -f db/k8s/postgres-pvc.yaml

    # 6Ô∏è‚É£ Apply PostgreSQL Secret
    - name: Apply PostgreSQL Secret
      run: kubectl apply -f db/k8s/postgres-secret.yaml

    # 7Ô∏è‚É£ Apply PostgreSQL Deployment
    - name: Apply PostgreSQL Deployment
      run: kubectl apply -f db/k8s/postgres-deployment.yaml

    # 8Ô∏è‚É£ Apply PostgreSQL Service
    - name: Apply PostgreSQL Service
      run: kubectl apply -f db/k8s/postgres-service.yaml

    # 9Ô∏è‚É£ Run Liquibase migrations
    - name: Run Liquibase Migrations
      working-directory: db
      run: |
        liquibase --changeLogFile=changelog/changelog-master.xml \
                  --url=jdbc:postgresql://postgres.db-ns.svc.cluster.local:5432/appdb \
                  --username=$POSTGRES_USER \
                  --password=$POSTGRES_PASSWORD \
                  update

    # üîü Build Flask Docker image
    - name: Build Flask Docker Image
      run: docker build -t flask-app:latest ./app

    # 1Ô∏è‚É£1Ô∏è‚É£ Apply Flask Deployment
    - name: Apply Flask Deployment
      run: kubectl apply -f app/k8s/flask-deployment.yaml

    # 1Ô∏è‚É£2Ô∏è‚É£ Apply Flask Service
    - name: Apply Flask Service
      run: kubectl apply -f app/k8s/flask-service.yaml

    # 1Ô∏è‚É£3Ô∏è‚É£ Verify Pods
    - name: Verify Pods
      run: kubectl get pods -n db-ns && kubectl get pods -n flask-app-ns

