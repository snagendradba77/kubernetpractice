name: App CI/CD Pipeline

on:
  push:
    branches: [dev]
    paths:
      - 'app/src/**'
      - 'app/Dockerfile'
      - 'app/k8s/**'

jobs:
  app:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      # Detect changed files
      - name: Get changed files
        id: changes
        run: |
          echo "files=$(git diff --name-only HEAD^ HEAD)" >> $GITHUB_OUTPUT

      # Filter app source, Dockerfile, and K8s
      - name: Filter App Changes
        id: filter
        run: |
          build=0
          deploy=0
          for f in ${{ steps.changes.outputs.files }}; do
            if [[ $f == app/src/** || $f == app/Dockerfile ]]; then
              build=1
            fi
            if [[ $f == app/k8s/** ]]; then
              deploy=1
            fi
          done
          echo "build=$build" >> $GITHUB_OUTPUT
          echo "deploy=$deploy" >> $GITHUB_OUTPUT

      # Build Docker image only if source/Dockerfile changed
      - name: Build Docker Image
        if: steps.filter.outputs.build == '1'
        run: |
          docker build -t your_dockerhub/flask-app:latest app/
          docker push your_dockerhub/flask-app:latest

      # Deploy to Kubernetes only if deployment files changed or build happened
      - name: Deploy Flask App
        if: steps.filter.outputs.deploy == '1' || steps.filter.outputs.build == '1'
        run: kubectl apply -f app/k8s/

